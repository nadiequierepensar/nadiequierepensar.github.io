<!doctype html>
<html lang="es">
<head>
  <!-- Favicon ‚Äì Ensayo -->
  <link rel="icon" type="image/png" href="../images/ensayo.png" sizes="any">
  <link rel="shortcut icon" href="../images/ensayo.png">
  <link rel="apple-touch-icon" href="../images/ensayo.png">

  <!-- Meta base -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <!-- Android / Desktop: color de la barra del navegador -->
  <meta name="theme-color" content="#2c2a89">  <!-- pon√© #000000 en p√°ginas negras como menu.html -->

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>Ensayo ‚Äî Paso 3</title>
  <link rel="stylesheet" href="../css/app.css?v=6">
  <style>
    /* Capital inicial mientras se escribe */
    .name-input { text-transform: capitalize; }

    /* Resaltado de campos duplicados */
    .dup {
      outline: 2px solid #ff5a5f;
      box-shadow: 0 0 0 3px rgba(255,90,95,.15);
    }
    .dup-hint {
      margin-top: 10px;
      font-size: .95rem;
      color: #ff5a5f;
      display: none;
    }
    .dup-hint.show { display: block; }
  </style>
</head>
<body class="page-ensayo1">
  <main>
    <div class="ensayo-wrap">
      <h1 class="ensayo-title">¬øC√≥mo se llaman?</h1>

      <form id="form3" class="ensayo-form" novalidate>
        <div id="campos"></div>

        <p id="dupHint" class="dup-hint">
          üí° <strong>Sugerencia:</strong> se detectaron nombres repetidos.
          Para no complicarla, agreguen un diferenciador (por ejemplo: ‚ÄúJuan‚Äù y ‚ÄúJuancho‚Äù).
        </p>

        <div class="ensayo-actions">
          <button id="next" class="btn btn-primary" type="submit" style="display:none">
            Siguiente ‚Üí
          </button>
        </div>
      </form>
    </div>
  </main>

  <script src="../js/nav-transitions.js?v=3"></script>
  <script>
  (function(){
    const KEY  = 'ensayo_state';
    const NEXT = 'ensayo4.html';

    // Capitaliza primera letra de cada palabra (soporta unicode)
    function properName(s){
      const lower = (s||'').toLocaleLowerCase('es-AR');
      return lower.replace(/\b([\p{L}\p{M}])([\p{L}\p{M}]*)/gu,
        (_, a, b) => a.toLocaleUpperCase('es-AR') + b);
    }

    // Normaliza para comparar: trim, min√∫sculas y sin acentos
    function norm(s){
      return (s||'')
        .trim()
        .toLocaleLowerCase('es-AR')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    }

    // Detecta duplicados: { dupKeys:Set, counts:Map, pretty:Map }
    function findDuplicates(values){
      const counts = new Map();
      const pretty = new Map();
      for (const v of values){
        const k = norm(v);
        if (!k) continue;
        counts.set(k, (counts.get(k)||0) + 1);
        if (!pretty.has(k)) pretty.set(k, properName(v));
      }
      const dupKeys = new Set([...counts.entries()].filter(([,c]) => c >= 2).map(([k]) => k));
      return { dupKeys, counts, pretty };
    }

    // Estado (fallback: al menos 1 integrante)
    let s = {};
    try { s = JSON.parse(sessionStorage.getItem(KEY) || '{}'); } catch {}
    const n = Math.max(1, Number(s.cantidad || 1));

    // Refs
    const form = document.getElementById('form3');
    const cont = document.getElementById('campos');
    const btn  = document.getElementById('next');
    const dupHint = document.getElementById('dupHint');

    // Crear inputs din√°micos
    const inputs = [];
    for (let i = 0; i < n; i++) {
      const wrap = document.createElement('div');
      wrap.style.marginTop = i === 0 ? '0' : '12px';

      const input = document.createElement('input');
      input.type = 'text';
      input.maxLength = 40;
      input.autocomplete = 'off';
      input.autocapitalize = 'words';
      input.setAttribute('enterkeyhint', i < n - 1 ? 'next' : 'done');
      input.className = 'ensayo-input name-input';
      input.placeholder = `Nombre del integrante ${i+1}`;
      if (Array.isArray(s.integrantes) && s.integrantes[i]) {
        input.value = properName(s.integrantes[i]);
      }

      // Normalizar y re-evaluar duplicados al salir
      input.addEventListener('blur', () => {
        input.value = properName(input.value.trim());
        checkDupes(false);
      });

      // Enter ‚Üí siguiente (√∫ltimo: submit)
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (i < n - 1) inputs[i+1].focus();
          else form.requestSubmit();
        }
      });

      // En vivo: habilitar bot√≥n y chequear duplicados
      input.addEventListener('input', () => {
        toggleNext();
        checkDupes(false);
      });

      wrap.appendChild(input);
      cont.appendChild(wrap);
      inputs.push(input);
    }

    // Mostrar bot√≥n s√≥lo cuando todos tienen texto
    function toggleNext() {
      const ok = inputs.every(el => el.value.trim().length > 0);
      btn.style.display = ok ? 'inline-block' : 'none';
    }
    toggleNext();

    // Marca/desmarca duplicados y muestra hint (no bloqueante)
    function checkDupes(showHint){
      const vals = inputs.map(el => el.value);
      const { dupKeys } = findDuplicates(vals);
      let any = false;
      inputs.forEach(el => {
        const isDup = dupKeys.has(norm(el.value));
        el.classList.toggle('dup', isDup);
        any = any || isDup;
      });
      dupHint.classList.toggle('show', !!(showHint && any));
      if (!showHint) dupHint.classList.remove('show');
      return any;
    }

    // Submit ‚Üí validar duplicados, confirmar y guardar
    form.addEventListener('submit', (ev) => {
      ev.preventDefault();

      const nombres = inputs.map(el => properName(el.value.trim()));
      if (nombres.some(v => !v)) { toggleNext(); return; }

      const { dupKeys, counts, pretty } = findDuplicates(nombres);
      if (dupKeys.size > 0) {
        inputs.forEach(el => el.classList.toggle('dup', dupKeys.has(norm(el.value))));

        const detalles = [...dupKeys]
          .map(k => `${pretty.get(k)} (${counts.get(k)})`)
          .join(', ');
        const msg =
          "Sugerencia üí°: se detectaron 2 o m√°s nombres repetidos (" + detalles + ").\n\n" +
          "Para no complicarla, les sugiero agregar un diferenciador, por ejemplo ‚ÄúJuan‚Äù y ‚ÄúJuancho‚Äù.\n\n" +
          "¬øQuer√©s continuar de todos modos?";
        dupHint.classList.add('show');

        const seguir = window.confirm(msg);
        if (!seguir) {
          const primeroDup = inputs.find(el => dupKeys.has(norm(el.value)));
          if (primeroDup) primeroDup.focus();
          return;
        }
      } else {
        dupHint.classList.remove('show');
      }

      sessionStorage.setItem(KEY, JSON.stringify({ ...s, integrantes: nombres }));
      if (window.startPageLeave) startPageLeave(NEXT);
      else location.href = NEXT;
    });
  })();
  </script>
</body>
</html>
