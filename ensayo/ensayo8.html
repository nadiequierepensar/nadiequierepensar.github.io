<!doctype html>
<html lang="es">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<!-- Android / Desktop: color de la barra del navegador -->
<meta name="theme-color" content="#2c2a89">  <!-- poné #000000 en páginas negras como menu.html -->

<!-- iOS PWA: usa el fondo de la página y pone iconos blancos -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">


  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ensayo — Paso 8</title>
  <link rel="stylesheet" href="../css/app.css?v=6">
  <style>
    /* Resumen */
    .result-wrap{ display:grid; gap:18px; }
    .result-title{ color:#fff; font-weight:900; font-size:2rem; line-height:1.2; margin-top:24px; text-align:left; }
    .result-sub{ color:#fff; font-size:1.1rem; margin-top:8px; }
    .list-results{ display:grid; gap:10px; margin-top:4px; }
    .line{ display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-radius:12px; background:rgba(0,0,0,.12); }
    .name{ color:#fff; font-size:1.05rem; }
    .amt{ color:#fff; font-weight:800; }

    /* Más espacio al final para que no tape los botones */
    .final-wrap{ padding-bottom: calc(128px + env(safe-area-inset-bottom, 0px)); }

    /* Botones inferiores fijos (sin difuminado) */
    .actions-bottom{
      position: fixed; left:0; right:0;
      bottom: calc(12px + env(safe-area-inset-bottom, 0px));
      display:flex; justify-content:center; gap:36px;
      z-index: 10; background: transparent;
    }
    .fab-stack{ display:grid; gap:6px; justify-items:center; }
    .fab{
      width:64px; height:64px; border-radius:999px; border:0; cursor:pointer;
      display:grid; place-items:center; color:#fff; font-size:22px; font-weight:700;
      box-shadow:0 6px 16px rgba(0,0,0,.35);
    }
    .fab.green{ background:#00C853; }  /* Reiniciar */
    .fab.red{   background:#FF0202; }  /* Compartir */
    .fab-label{ color:#fff; font-size:.85rem; opacity:.95; }
  </style>
</head>
<body class="page-ensayo1">
  <main>
    <div class="ensayo-wrap final-wrap">
      <div class="result-wrap">
        <h1 id="tit" class="result-title">Resultado del ensayo</h1>
        <div class="result-sub">Cada uno:</div>
        <div id="lista" class="list-results"></div>
      </div>
    </div>

    <!-- Botones fijos, abajo de todo -->
    <div class="actions-bottom">
      <div class="fab-stack">
        <button id="reiniciar" class="fab green" title="Reiniciar">↺</button>
        <div class="fab-label">Reiniciar</div>
      </div>
      <div class="fab-stack">
        <button id="compartir" class="fab red" title="Compartir">⤴</button>
        <div class="fab-label">Compartir</div>
      </div>
    </div>
  </main>

  <script src="../js/nav-transitions.js?v=3"></script>
  <script>
    (function(){
      const KEY='ensayo_state';
      function getState(){ try{ return JSON.parse(sessionStorage.getItem(KEY)||'{}'); }catch{ return {}; } }
      const s = getState();

      // Datos base
      const banda   = s.banda || 'banda';
      const nombres = Array.isArray(s.integrantes) && s.integrantes.length
        ? s.integrantes
        : (Number.isFinite(+s.cantidad) && +s.cantidad > 0
            ? Array.from({length:+s.cantidad}, (_,i)=>`Integrante ${i+1}`)
            : []);
      const cant = nombres.length || 1;

      const valorSala    = Number.isFinite(+s.valorSala)    ? +s.valorSala    : 0;
      const valorAlcohol = Number.isFinite(+s.valorAlcohol) ? +s.valorAlcohol : 0;

      // Tomadores
      let tomadoresIdx = Array.isArray(s.quienesTomaronIdx) ? s.quienesTomaronIdx.slice() : null;
      if (!tomadoresIdx && Array.isArray(s.quienesTomaronNombres) && nombres.length){
        tomadoresIdx = nombres
          .map((nm,i) => s.quienesTomaronNombres.includes(nm) ? i : -1)
          .filter(i => i >= 0);
      }
      const tomCount = Array.isArray(tomadoresIdx) ? tomadoresIdx.length : 0;

      const money = (n) => '$' + (n|0).toLocaleString('es-AR');

      // Cálculos (enteros)
      const perSala    = Math.trunc(valorSala / Math.max(1, cant));
      const perAlcohol = tomCount > 0 ? Math.trunc(valorAlcohol / tomCount) : 0;
      const totalGeneral = (valorSala|0) + (valorAlcohol|0);

      // Título
      document.getElementById('tit').textContent = `${banda}, el total es de ${money(totalGeneral)}`;

      // Lista por persona
      const ul = document.getElementById('lista');
      nombres.forEach((name, idx) => {
        const tomo = Array.isArray(tomadoresIdx) && tomadoresIdx.includes(idx);
        const total = perSala + (tomo ? perAlcohol : 0);

        const row = document.createElement('div'); row.className = 'line';
        const nEl = document.createElement('div'); nEl.className = 'name'; nEl.textContent = name;
        const aEl = document.createElement('div'); aEl.className = 'amt';  aEl.textContent = money(total);
        row.appendChild(nEl); row.appendChild(aEl);
        ul.appendChild(row);
      });

      // Reiniciar → limpia estado y vuelve al menú
      document.getElementById('reiniciar').addEventListener('click', () => {
        sessionStorage.removeItem(KEY);
        if (window.startPageLeave) startPageLeave('../menu.html', true);
        else location.replace('../menu.html');
      });

      // Compartir → Web Share si existe, sino copia
      document.getElementById('compartir').addEventListener('click', async () => {
        const lines = [];
        lines.push(`Banda: ${banda}`);
        lines.push(`Sala: ${money(valorSala)}  |  Alcohol: ${money(valorAlcohol)}`);
        lines.push(`Total: ${money(totalGeneral)}`);
        lines.push('');
        lines.push('Cada uno:');
        nombres.forEach((name, idx) => {
          const tomo = Array.isArray(tomadoresIdx) && tomadoresIdx.includes(idx);
          const total = perSala + (tomo ? perAlcohol : 0);
          lines.push(`- ${name}: ${money(total)}${tomo ? ' (tomó)' : ''}`);
        });
        const text = lines.join('\n');

        try{
          if (navigator.share) {
            await navigator.share({ title: `Ensayo — ${banda}`, text });
          } else if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            alert('Resumen copiado al portapapeles.');
          } else {
            const ta = document.createElement('textarea');
            ta.value = text; document.body.appendChild(ta);
            ta.select(); document.execCommand('copy'); ta.remove();
            alert('Resumen copiado al portapapeles.');
          }
        }catch(e){
          console.error(e);
          alert('No se pudo compartir/copiar el resumen.');
        }
      });
    })();
  </script>
</body>
</html>
