<!doctype html>
<html lang="es">
<head>
<!-- Favicon – Juntada -->
<link rel="icon" type="image/png" href="../images/juntada.png" sizes="any">
<link rel="shortcut icon" href="../images/juntada.png">
<link rel="apple-touch-icon" href="../images/juntada.png">

  <!-- Meta base -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Android / Desktop: color de la barra del navegador -->
  <meta name="theme-color" content="#7414b2">

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>Juntadas — Resumen</title>
  <link rel="stylesheet" href="../css/app.css?v=6" />

  <style>
    /* ===== Contenedor (mismo ancho que Canchita) ===== */
    .j4-wrap{
      width: min(720px, 94vw);
      margin: 0 auto;
      padding: 24px 20px 24px;
    }

    /* ===== Títulos / subtítulos ===== */
    .result-wrap{ display:grid; gap:18px; }
    .result-title{
      color:#fff; font-weight:900; font-size:2rem; line-height:1.2;
      margin-top:24px; text-align:left;
    }
    .result-sub{ color:#fff; font-size:1.05rem; }
    .section-title{ font-weight:800; margin-top:10px; }

    /* ===== Listas tipo pastilla ===== */
    .list-results{ display:grid; gap:10px; margin-top:4px; }

    /* Forzar Grid (evita space-between heredado) */
    .page-juntadas1 .list-results .line{
      display:grid; grid-template-columns:1fr auto; align-items:center;
      column-gap: 10px; /* <-- cambiá aquí para más/menos espacio */
      padding:10px 12px; border-radius:12px; background:rgba(0,0,0,.12);
      justify-content: initial; /* anula cualquier justify-content previo */
    }
    .page-juntadas1 .list-results .line .name{ color:#fff; font-size:1.05rem; min-width:0; }
    .page-juntadas1 .list-results .line .amt{ color:#fff; font-weight:800; white-space:nowrap; }

    /* ===== Botones al final (no fijos) ===== */
    .actions-bottom{
      display:flex; justify-content:center; gap:28px;
      margin:22px auto 6px;
    }
    .fab-stack{ display:grid; gap:6px; justify-items:center; }
    .fab{
      width:64px; height:64px; border-radius:999px; border:0; cursor:pointer;
      display:grid; place-items:center; color:#fff; font-size:22px; font-weight:700;
      box-shadow:0 6px 16px rgba(0,0,0,.35);
    }
    .fab.green{ background:#00C853; }  /* Reiniciar */
    .fab.red{   background:#FF0202; }  /* Compartir */
    .fab-label{ color:#fff; font-size:.85rem; opacity:.95; }

    /* ===== Tweaks responsive ===== */
    @media (max-width:420px){
      .result-title{ font-size:1.8rem; }
      .page-juntadas1 .list-results .line{ column-gap:8px; padding:10px 10px; }
      .actions-bottom{ gap:22px; }
      .fab{ width:58px; height:58px; font-size:20px; }
    }
  </style>
</head>

<body class="page-juntadas1">
  <main>
    <div class="j4-wrap">
      <div class="result-wrap">
        <h1 class="result-title">Resumen de la juntada</h1>
        <div id="sub" class="result-sub">Total: $0 • Cada uno: $0</div>

        <!-- Balances por persona -->
        <div id="balances" class="list-results"></div>

        <!-- Sugerencias -->
        <div class="result-sub section-title">Sugerencias:</div>
        <div id="sugerencias" class="list-results"></div>

        <div id="fin" class="result-sub" style="font-weight:800;"></div>
      </div>

<!-- Donar -->
<div class="donate-wrap">
  <a class="donate-btn"
     href="https://cafecito.app/nadiequierepensar"
     target="_blank" rel="noopener noreferrer">
    ¿Les sirvió? Invítenme un cafecito ☕
  </a>
</div>

      <!-- Botones al final del contenido -->
      <div class="actions-bottom">
        <div class="fab-stack">
          <button id="reiniciar" class="fab green" title="Reiniciar">↺</button>
          <div class="fab-label">Reiniciar</div>
        </div>
        <div class="fab-stack">
          <button id="compartir" class="fab red" title="Compartir">⤴</button>
          <div class="fab-label">Compartir</div>
        </div>
      </div>
    </div>
  </main>

  <script src="../js/nav-transitions.js?v=3"></script>
  <script>
  (function(){
    const KEY = 'juntada_state';
    const $ = (sel) => document.querySelector(sel);
    const dinero = (n) => '$' + Math.trunc(n || 0).toLocaleString('es-AR');

    // Estado
    let s = {};
    try { s = JSON.parse(sessionStorage.getItem(KEY) || '{}'); } catch {}
    const nombres = Array.isArray(s.integrantes) ? s.integrantes : [];
    const gastos  = Array.isArray(s.gastos) ? s.gastos.map(x => Number(x)||0) : [];
    const n = Math.max(nombres.length, gastos.length);
    if (!n) { location.href = 'juntadas1.html'; return; }

    // Total / por cabeza
    const total = gastos.slice(0, n).reduce((a,b)=> a + (Number(b)||0), 0);
    const porCabeza = total / n;
    $('#sub').textContent = `Total: ${dinero(total)} • Cada uno: ${dinero(porCabeza)}`;

    // Balances
    const balances = [];
    for (let i=0; i<n; i++){
      const nombre = nombres[i] || ('Persona ' + (i+1));
      const pagado = Number(gastos[i]||0);
      const bal = Math.trunc(pagado - porCabeza);
      balances.push({ nombre, bal });
    }

    // Render balances (pastillas)
    const $bal = $('#balances');
    balances.forEach(({nombre, bal}) => {
      const row = document.createElement('div'); row.className = 'line';
      const left = document.createElement('div'); left.className = 'name';
      const right = document.createElement('div'); right.className = 'amt';

      if (bal > 0)      { left.textContent = `${nombre} tiene a favor`; right.textContent = dinero(bal); }
      else if (bal < 0) { left.textContent = `${nombre} debe`;          right.textContent = dinero(Math.abs(bal)); }
      else              { left.textContent = `${nombre} está a mano`;    right.textContent = '—'; }

      row.appendChild(left); row.appendChild(right); $bal.appendChild(row);
    });

    // Sugerencias (greedy)
    let acreedores = balances.filter(b => b.bal > 0)
      .map(b => ({ nombre: b.nombre, monto: Math.trunc(b.bal) }))
      .sort((a,b)=> b.monto - a.monto);
    let deudores = balances.filter(b => b.bal < 0)
      .map(b => ({ nombre: b.nombre, monto: Math.trunc(-b.bal) }))
      .sort((a,b)=> b.monto - a.monto);

    const movs = [];
    let i=0, j=0;
    while (i<deudores.length && j<acreedores.length){
      const deb = deudores[i], cre = acreedores[j];
      const xfer = Math.min(deb.monto, cre.monto);
      if (xfer > 0) movs.push({ de: deb.nombre, para: cre.nombre, monto: xfer });
      deb.monto -= xfer; cre.monto -= xfer;
      if (deb.monto === 0) i++;
      if (cre.monto === 0) j++;
    }

    // Render sugerencias (texto + monto separado a la derecha)
    const $sug = $('#sugerencias');
    if (movs.length === 0){
      const row = document.createElement('div'); row.className = 'line';
      row.innerHTML = `<div class="name">No hay movimientos</div><div class="amt">—</div>`;
      $sug.appendChild(row);
    } else {
      movs.forEach(({de, para, monto}) => {
        const row = document.createElement('div'); row.className = 'line';
        row.innerHTML = `<div class="name">${de} le transfiere a ${para}</div><div class="amt">${dinero(monto)}</div>`;
        $sug.appendChild(row);
      });
    }

    // Cierre
    $('#fin').textContent = 'Y quedarían todos a mano.';

    // Reiniciar
    document.getElementById('reiniciar').addEventListener('click', () => {
      sessionStorage.removeItem(KEY);
      if (window.startPageLeave) startPageLeave('../menu.html', true);
      else location.replace('../menu.html');
    });

    // Compartir
    document.getElementById('compartir').addEventListener('click', async () => {
      const lines = [];
      lines.push(`Total: ${dinero(total)}`);
      lines.push(`Cada uno: ${dinero(porCabeza)}`);
      lines.push('');
      balances.forEach(({nombre, bal}) => {
        if (bal > 0) lines.push(`${nombre} tiene a favor ${dinero(bal)}`);
        else if (bal < 0) lines.push(`${nombre} debe ${dinero(Math.abs(bal))}`);
        else lines.push(`${nombre} está a mano`);
      });
      lines.push('');
      if (movs.length){
        lines.push('Sugerencias:');
        movs.forEach(({de, para, monto}) => lines.push(`${de} le transfiere ${dinero(monto)} a ${para}`));
      } else {
        lines.push('No hay movimientos.');
      }
      lines.push('');
      lines.push('Y quedarían todos a mano.');
      const text = lines.join('\n');

      try{
        if (navigator.share) {
          await navigator.share({ title:'Juntada — Resumen', text });
        } else if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          alert('Resumen copiado al portapapeles.');
        } else {
          const ta=document.createElement('textarea'); ta.value=text;
          document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
          alert('Resumen copiado al portapapeles.');
        }
      }catch(e){
        console.error(e);
        alert('No se pudo compartir/copiar el resumen.');
      }
    });
  })();
  </script>
</body>
</html>
