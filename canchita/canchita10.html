<!doctype html>
<html lang="es">
<head>
<!-- Favicon – Canchita -->
<link rel="icon" type="image/png" href="../images/canchita.png" sizes="any">
<link rel="shortcut icon" href="../images/canchita.png">
<link rel="apple-touch-icon" href="../images/canchita.png">
  <!-- Meta & PWA -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#2a892e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>Canchita — Resumen</title>
  <link rel="stylesheet" href="../css/app.css?v=6">

  <style>
    /* Contenedor (igual que juntadas/ensayo) */
    .c10-wrap{
      width: min(720px, 94vw);
      margin: 0 auto;
      padding: 24px 20px 24px;
    }

    /* Resumen */
    .result-wrap{ display:grid; gap:18px; }

    /* H1 alineado al borde interno (sin márgenes laterales) */
    .result-title{
      color:#fff; font-weight:900; font-size:2rem; line-height:1.2;
      margin:24px 0 0 0;
      text-align:left;
    }

    .result-sub{ color:#fff; font-size:1.1rem; margin-top:8px; }

    .list-results{ display:grid; gap:10px; margin-top:4px; }

    /* Pastillas: Grid (texto izq 1fr, monto der auto) */
    .page-canchita .list-results .line{
      display:grid; grid-template-columns:1fr auto; align-items:center;
      column-gap:10px;
      padding:10px 12px; border-radius:12px; background:rgba(0,0,0,.12);
      justify-content: initial; /* neutraliza space-between heredado si lo hubiera */
    }
    .page-canchita .list-results .line .name{ color:#fff; font-size:1.05rem; min-width:0; }
    .page-canchita .list-results .line .amt{ color:#fff; font-weight:800; white-space:nowrap; }

    /* Ya no necesitamos espacio extra para botones fijos */
    .final-wrap{ padding-bottom:24px; }

    /* Botones al final (no fijos) */
    .actions-bottom{
      display:flex; justify-content:center; gap:28px;
      margin:22px auto 6px;
    }
    .fab-stack{ display:grid; gap:6px; justify-items:center; }
    .fab{
      width:64px; height:64px; border-radius:999px; border:0; cursor:pointer;
      display:grid; place-items:center; color:#fff; font-size:22px; font-weight:700;
      box-shadow:0 6px 16px rgba(0,0,0,.35);
    }
    .fab.green{ background:#00C853; }  /* Reiniciar */
    .fab.red{   background:#FF0202; }  /* Compartir */
    .fab-label{ color:#fff; font-size:.85rem; opacity:.95; }

    /* Tweaks responsive */
    @media (max-width:420px){
      .result-title{ font-size:1.8rem; }
      .page-canchita .list-results .line{ column-gap:8px; padding:10px 10px; }
      .actions-bottom{ gap:22px; }
      .fab{ width:58px; height:58px; font-size:20px; }
    }
  </style>
</head>

<body class="page-canchita">
  <main>
    <div class="c10-wrap final-wrap">
      <div class="result-wrap">
        <h1 id="tit" class="result-title">Resultado del partido</h1>
        <div id="sub" class="result-sub">Cada uno:</div>
        <div id="lista" class="list-results"></div>
      </div>
	  
<!-- Donar -->
<div class="donate-wrap">
  <a class="donate-btn"
     href="https://cafecito.app/nadiequierepensar"
     target="_blank" rel="noopener noreferrer">
    ¿Les sirvió? Invítenme un cafecito ☕
  </a>
</div>

      <!-- Botones al final, en flujo -->
      <div class="actions-bottom">
        <div class="fab-stack">
          <button id="reiniciar" class="fab green" title="Reiniciar">↺</button>
          <div class="fab-label">Reiniciar</div>
        </div>
        <div class="fab-stack">
          <button id="compartir" class="fab red" title="Compartir">⤴</button>
          <div class="fab-label">Compartir</div>
        </div>
      </div>
    </div>
  </main>

  <script src="../js/nav-transitions.js?v=3"></script>
  <script>
    (function(){
      const KEY = 'canchita_state_v1';
      const BACK_TO_NAMES = 'canchita2.html';

      // Leer estado
      let s = {};
      try { s = JSON.parse(sessionStorage.getItem(KEY) || '{}'); } catch {}

      // Nombres de jugadores (o placeholders). Si no hay, volver a C2
      const nombres = Array.isArray(s.jugadores) && s.jugadores.length
        ? s.jugadores
        : (Number.isFinite(+s.cantidad) && +s.cantidad > 0
            ? Array.from({length:+s.cantidad}, (_,i)=>`Jugador ${i+1}`)
            : []);
      if (!nombres.length){
        if (window.startPageLeave) startPageLeave(BACK_TO_NAMES, true);
        else location.href = BACK_TO_NAMES;
        return;
      }
      const cant = nombres.length;

      // Valores base
      const precioCanchita = Number.isFinite(+s.precio_canchita) ? +s.precio_canchita : 0;

      // Equipamiento
      const equip = s.equipamiento || {};
      const huboEquip   = equip.hubo === true && Number.isFinite(+equip.precio) && +equip.precio > 0;
      const equipPrecio = huboEquip ? +equip.precio : 0;
      const equipIdx    = Array.isArray(equip.jugadores) ? equip.jugadores.map(Number).filter(Number.isInteger) : [];
      const equipCount  = huboEquip ? (equipIdx.length || 0) : 0;

      // 3° tiempo
      const tt = s.tercer_tiempo || {};
      const huboTT   = tt.hubo === true && Number.isFinite(+tt.precio) && +tt.precio > 0;
      const ttPrecio = huboTT ? +tt.precio : 0;
      const ttIdx    = Array.isArray(tt.jugadores) ? tt.jugadores.map(Number).filter(Number.isInteger) : [];
      const ttCount  = huboTT ? (ttIdx.length || 0) : 0;

      // Helpers
      const money = (n) => '$' + (n|0).toLocaleString('es-AR');

      // Cálculos (enteros truncados)
      const perCanchita = Math.trunc(precioCanchita / Math.max(1, cant));
      const perEquip    = huboEquip && equipCount > 0 ? Math.trunc(equipPrecio / equipCount) : 0;
      const perTT       = huboTT   && ttCount    > 0 ? Math.trunc(ttPrecio / ttCount)       : 0;

      const totalGeneral = (precioCanchita|0) + (equipPrecio|0) + (ttPrecio|0);

      // Título fijo y subtítulo con total + “cada uno”
      document.getElementById('tit').textContent = 'Resultado del partido';
      document.getElementById('sub').textContent = `Total: ${money(totalGeneral)} • Cada uno:`;

      // Lista por persona
      const ul = document.getElementById('lista');
      nombres.forEach((name, idx) => {
        const pagaEquip = huboEquip && equipIdx.includes(idx);
        const pagaTT    = huboTT   && ttIdx.includes(idx);
        const total = perCanchita + (pagaEquip ? perEquip : 0) + (pagaTT ? perTT : 0);

        const row = document.createElement('div'); row.className = 'line';
        const nEl = document.createElement('div'); nEl.className = 'name'; nEl.textContent = name;
        const aEl = document.createElement('div'); aEl.className = 'amt';  aEl.textContent = money(total);
        row.appendChild(nEl); row.appendChild(aEl);
        ul.appendChild(row);
      });

      // Reiniciar → limpia estado y vuelve al menú
      document.getElementById('reiniciar').addEventListener('click', () => {
        sessionStorage.removeItem(KEY);
        if (window.startPageLeave) startPageLeave('../menu.html', true);
        else location.replace('../menu.html');
      });

      // Compartir
      document.getElementById('compartir').addEventListener('click', async () => {
        const lines = [];
        lines.push('Partido');
        lines.push(`Canchita: ${money(precioCanchita)}  |  Equipamiento: ${money(equipPrecio)}  |  3° tiempo: ${money(ttPrecio)}`);
        lines.push(`Total: ${money(totalGeneral)}`);
        lines.push('');
        lines.push('Cada uno:');
        nombres.forEach((name, idx) => {
          const pagaEquip = huboEquip && equipIdx.includes(idx);
          const pagaTT    = huboTT   && ttIdx.includes(idx);
          const total = perCanchita + (pagaEquip ? perEquip : 0) + (pagaTT ? perTT : 0);
          const tags = [pagaEquip ? 'equipamiento' : '', pagaTT ? '3° tiempo' : ''].filter(Boolean).join(' + ');
          lines.push(`- ${name}: ${money(total)}${tags ? ` (${tags})` : ''}`);
        });
        const text = lines.join('\n');

        try{
          if (navigator.share) {
            await navigator.share({ title: 'Canchita — Resultado', text });
          } else if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            alert('Resumen copiado al portapapeles.');
          } else {
            const ta = document.createElement('textarea');
            ta.value = text; document.body.appendChild(ta);
            ta.select(); document.execCommand('copy'); ta.remove();
            alert('Resumen copiado al portapapeles.');
          }
        }catch(e){
          console.error(e);
          alert('No se pudo compartir/copiar el resumen.');
        }
      });
    })();
  </script>
</body>
</html>
