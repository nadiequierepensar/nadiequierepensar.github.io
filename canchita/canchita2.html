<!doctype html>
<html lang="es">
<head>
  <!-- Favicon ‚Äì Canchita -->
  <link rel="icon" type="image/png" href="../images/canchita.png" sizes="any">
  <link rel="shortcut icon" href="../images/canchita.png">
  <link rel="apple-touch-icon" href="../images/canchita.png">

  <!-- Meta base -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Android / Desktop: color de la barra del navegador (Canchita) -->
  <meta name="theme-color" content="#2a892e">

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- T√≠tulo y estilos -->
  <title>Canchita ‚Äî Paso 2</title>
  <link rel="stylesheet" href="../css/app.css?v=6">

  <style>
    /* Inicial may√∫scula mientras se escribe */
    .name-input { text-transform: capitalize; }

    /* Resaltado de campos duplicados */
    .dup {
      outline: 2px solid #ff5a5f;
      box-shadow: 0 0 0 3px rgba(255,90,95,.15);
    }
    .dup-hint {
      margin-top: 10px;
      font-size: .95rem;
      color: #ff5a5f;
      display: none;
    }
    .dup-hint.show { display: block; }
  </style>
</head>
<body class="page-canchita">
  <main>
    <div class="canchita-wrap">
      <h1 class="canchita-title">¬øC√≥mo se llaman los jugadores?</h1>

      <form id="form2" class="canchita-form" novalidate>
        <div id="campos"></div>

        <p id="dupHint" class="dup-hint">
          üí° <strong>Sugerencia:</strong> se detectaron nombres repetidos.
          Para no complicarla, agreguen un diferenciador (por ejemplo: ‚ÄúJuan‚Äù y ‚ÄúJuancho‚Äù).
        </p>

        <div class="canchita-actions">
          <button id="next" class="btn btn-primary" type="submit" style="display:none">
            Siguiente ‚Üí
          </button>
        </div>
      </form>
    </div>
  </main>

  <script src="../js/nav-transitions.js?v=3"></script>
  <script>
  (function(){
    const KEY  = 'canchita_state_v1';
    const NEXT = 'canchita3.html';

    // Capitaliza primera letra de cada palabra (con soporte unicode)
    function properName(s){
      const lower = (s||'').toLocaleLowerCase('es-AR');
      return lower.replace(/\b([\p{L}\p{M}])([\p{L}\p{M}]*)/gu,
        (_, a, b) => a.toLocaleUpperCase('es-AR') + b);
    }

    // Normaliza para comparar: trim, min√∫sculas, sin acentos
    function norm(s){
      return (s||'')
        .trim()
        .toLocaleLowerCase('es-AR')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    }

    // Detecta duplicados
    function findDuplicates(values){
      const counts = new Map();
      const pretty = new Map();
      for (const v of values){
        const k = norm(v);
        if (!k) continue;
        counts.set(k, (counts.get(k)||0) + 1);
        if (!pretty.has(k)) pretty.set(k, properName(v));
      }
      const dupKeys = new Set([...counts.entries()].filter(([,c]) => c >= 2).map(([k]) => k));
      return { dupKeys, counts, pretty };
    }

    // Estado (fallback: al menos 1 jugador)
    let st = {};
    try { st = JSON.parse(sessionStorage.getItem(KEY) || '{}'); } catch {}
    const n = Math.max(1, Number(st.cantidad || 1));

    // Refs
    const form = document.getElementById('form2');
    const cont = document.getElementById('campos');
    const btn  = document.getElementById('next');
    const dupHint = document.getElementById('dupHint');

    // Crear inputs din√°micos
    const inputs = [];
    for (let i = 0; i < n; i++) {
      const wrap = document.createElement('div');
      wrap.style.marginTop = i === 0 ? '0' : '12px';

      const input = document.createElement('input');
      input.type = 'text';
      input.maxLength = 22;
      input.autocomplete = 'off';
      input.autocapitalize = 'words';
      input.setAttribute('enterkeyhint', i < n - 1 ? 'next' : 'done');
      input.className = 'canchita-input name-input';
      input.placeholder = `Nombre del jugador ${i+1}`;

      if (Array.isArray(st.jugadores) && st.jugadores[i]) {
        input.value = properName(st.jugadores[i]);
      }

      // Normalizar al salir
      input.addEventListener('blur', () => {
        input.value = properName(input.value.trim());
        checkDupes(false);
      });

      // Enter ‚Üí siguiente (√∫ltimo: submit)
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (i < n - 1) inputs[i+1].focus();
          else form.requestSubmit();
        }
      });

      // ‚¨ÖÔ∏è Backspace en campo vac√≠o ‚Üí foco al anterior y caret al final (sin borrar)
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && input.value.length === 0 && i > 0) {
          e.preventDefault();
          const prev = inputs[i - 1];
          prev.focus();
          const end = prev.value.length;
          try { prev.setSelectionRange(end, end); } catch {}
        }
      });

      // En vivo: bot√≥n + duplicados
      input.addEventListener('input', () => {
        toggleNext();
        checkDupes(false);
      });

      wrap.appendChild(input);
      cont.appendChild(wrap);
      inputs.push(input);
    }

    // Mostrar bot√≥n s√≥lo cuando todos tienen texto
    function toggleNext() {
      const ok = inputs.every(el => el.value.trim().length > 0);
      btn.style.display = ok ? 'inline-block' : 'none';
    }
    toggleNext();

    // Marca/desmarca duplicados y muestra hint (no bloqueante)
    function checkDupes(showHint){
      const vals = inputs.map(el => el.value);
      const { dupKeys } = findDuplicates(vals);
      let any = false;
      inputs.forEach(el => {
        const isDup = dupKeys.has(norm(el.value));
        el.classList.toggle('dup', isDup);
        any = any || isDup;
      });
      dupHint.classList.toggle('show', !!(showHint && any));
      if (!showHint) dupHint.classList.remove('show');
      return any;
    }

    // Submit ‚Üí validar duplicados, confirmar y guardar
    form.addEventListener('submit', (ev) => {
      ev.preventDefault();

      const nombres = inputs.map(el => properName(el.value.trim()));
      if (nombres.some(v => !v)) { toggleNext(); return; }

      const { dupKeys, counts, pretty } = findDuplicates(nombres);
      if (dupKeys.size > 0) {
        inputs.forEach(el => el.classList.toggle('dup', dupKeys.has(norm(el.value))));
        const detalles = [...dupKeys]
          .map(k => `${pretty.get(k)} (${counts.get(k)})`)
          .join(', ');
        const msg =
          "Sugerencia üí°: se detectaron nombres repetidos (" + detalles + ").\n\n" +
          "Para no complicarla, les sugiero agregar un diferenciador, por ejemplo ‚ÄúJuan‚Äù y ‚ÄúJuancho‚Äù.\n\n" +
          "¬øQuer√©s continuar de todos modos?";
        dupHint.classList.add('show');

        const seguir = window.confirm(msg);
        if (!seguir) {
          const primeroDup = inputs.find(el => dupKeys.has(norm(el.value)));
          if (primeroDup) primeroDup.focus();
          return;
        }
      } else {
        dupHint.classList.remove('show');
      }

      sessionStorage.setItem(KEY, JSON.stringify({ ...st, jugadores: nombres }));
      if (window.startPageLeave) startPageLeave(NEXT);
      else location.href = NEXT;
    });
  })();
  </script>
</body>
</html>
